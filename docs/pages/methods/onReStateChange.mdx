# onReStateChange

Subscribe to state changes outside of React components. This function lets you run side effects whenever specific state keys change, similar to `useEffect` but without requiring a React component.

## Why use onReStateChange?

- **Side effects outside React**: Sync state with localStorage, analytics, or external APIs
- **Selective subscriptions**: Only trigger when specific state keys change
- **No component required**: Run logic in plain JavaScript/TypeScript files
- **Multiple dependencies**: Watch multiple state keys with a single subscription

## Basic Usage

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

const { dispatchTheme } = createReStateMethods('theme', 'light');

// Subscribe to theme changes
const unsubscribe = onReStateChange(() => {
  console.log('Theme changed!');
}, ['theme']);

// Later, when theme changes, the callback runs
dispatchTheme('dark'); // Logs: "Theme changed!"

// Stop listening when no longer needed
unsubscribe();
```

## Examples

### Syncing with localStorage

Persist state changes to localStorage automatically:

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

interface User {
  name: string;
  token: string;
}

// Restore from localStorage on creation using a function initialValue
const { getUser } = createReStateMethods<'user', User>('user', () => {
  const saved = localStorage.getItem('user');
  return saved ? JSON.parse(saved) : { name: '', token: '' };
});

// Save user to localStorage whenever it changes
onReStateChange(() => {
  const user = getUser();
  localStorage.setItem('user', JSON.stringify(user));
}, ['user']);
```

### Analytics Tracking

Track state changes for analytics:

```ts
import { onReStateChange } from '@raulpesilva/re-state';
import { analytics } from './analytics';

onReStateChange(() => {
  analytics.track('cart_updated');
}, ['cart']);

onReStateChange(() => {
  analytics.track('user_preferences_changed');
}, ['preferences']);
```

### Watching Multiple Keys

Subscribe to multiple state keys with a single callback:

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

const { getVolume } = createReStateMethods('volume', 50);
const { getMuted } = createReStateMethods('muted', false);

// Called when either volume OR muted changes
onReStateChange(() => {
  const volume = getVolume();
  const muted = getMuted();
  
  // Update audio element
  const audio = document.querySelector('audio');
  if (audio) {
    audio.volume = muted ? 0 : volume / 100;
  }
}, ['volume', 'muted']);
```

### Syncing with External APIs

Push state changes to a server:

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

const { getSettings } = createReStateMethods('settings', {
  notifications: true,
  theme: 'light',
});

onReStateChange(() => {
  const settings = getSettings();
  
  fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings),
  });
}, ['settings']);
```

### Logging and Debugging

Log state changes during development:

```ts
import { onReStateChange } from '@raulpesilva/re-state';

if (process.env.NODE_ENV === 'development') {
  onReStateChange(() => {
    console.log('[ReState] Auth state changed');
  }, ['user', 'token', 'permissions']);
}
```

### DOM Updates Outside React

Update DOM elements that aren't managed by React:

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

const { getTheme } = createReStateMethods('theme', 'light');

onReStateChange(() => {
  const theme = getTheme();
  document.documentElement.setAttribute('data-theme', theme);
}, ['theme']);
```

### Cleanup with Unsubscribe

Stop listening when a subscription is no longer needed:

```ts
import { createReStateMethods, onReStateChange } from '@raulpesilva/re-state';

const { dispatchStatus } = createReStateMethods('connectionStatus', 'disconnected');

// Subscribe to connection status changes
const unsubscribe = onReStateChange(() => {
  console.log('Connection status changed');
}, ['connectionStatus']);

// Start monitoring
dispatchStatus('connected'); // Logs: "Connection status changed"

// Later, stop monitoring
unsubscribe();

// This will NOT trigger the callback
dispatchStatus('disconnected');
```

### React useEffect Integration

Clean up subscriptions when a component unmounts:

```tsx
import { useEffect } from 'react';
import { onReStateChange } from '@raulpesilva/re-state';

function ConnectionMonitor() {
  useEffect(() => {
    const unsubscribe = onReStateChange(() => {
      console.log('Connection changed');
    }, ['connectionStatus']);

    // Cleanup on unmount
    return unsubscribe;
  }, []);

  return <div>Monitoring connection...</div>;
}
```

## API Reference

```ts
function onReStateChange(
  callback: () => void,
  dependencies: string[]
): () => void
```

### Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `callback` | `() => void` | Yes | Function to call when any dependency changes |
| `dependencies` | `string[]` | Yes | Array of state keys to watch |

### Returns

| Type | Description |
|------|-------------|
| `() => void` | Unsubscribe function that stops listening to changes |

### Behavior

- The callback is **not** called on initial subscription, only on subsequent changes
- The callback runs once per state change, even if multiple dependencies change simultaneously
- Call the returned function to unsubscribe and stop receiving updates

## When to Use

| Use Case | Recommended |
|----------|-------------|
| Persist state to localStorage | `onReStateChange` |
| Sync state with server | `onReStateChange` |
| Analytics tracking | `onReStateChange` |
| Update non-React DOM elements | `onReStateChange` |
| React component side effects | `useEffect` with hooks from `createReStateMethods` |
